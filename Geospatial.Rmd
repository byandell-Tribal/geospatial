---
title: "Geospatial"
author: "Brian Yandell"
date: "2023-06-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

See <README.md>.

# Day 1: Raster Data

```{r}
HARV_dsmCrop_info <-
  utils::capture.output(
    terra::describe("data/raster/HARV_dsmCrop.tif"))
```

```{r}
(DSM_HARV <- terra::rast("data/raster/HARV_dsmCrop.tif"))
```

```{r}
summary(terra::values(DSM_HARV))
```
## Plot raster data

You must create df from raster data for use in ggplot2,
say using S4 method for `SpatVector` object

```{r}
ggplot2::ggplot(
  as.data.frame(DSM_HARV, xy = TRUE)) +
  ggplot2::aes(x, y, fill = HARV_dsmCrop) +
  # Raster geometry
  ggplot2::geom_raster() +
  # Add Viridis gradient scale
  ggplot2::scale_fill_viridis_c()
```

Quick plot of raster

```{r}
plot(DSM_HARV)
```

### Look at coordinate reference system

- is it projected or not?
- what units?
- where is this place?

```{r}
terra::crs(DSM_HARV, proj = TRUE)
```

```{r}
terra::minmax(DSM_HARV)
```

Force saving of min and max with object.

```{r}
DSM_HARV <- terra::setMinMax(DSM_HARV)
```

### Plot histogram of data

```{r}
ggplot2::ggplot(
  as.data.frame(DSM_HARV, xy = TRUE)) +
  ggplot2::aes(HARV_dsmCrop) +
  # Histogram
  ggplot2::geom_histogram()
```

```{r}
ggplot2::ggplot(
  as.data.frame(DSM_HARV, xy = TRUE)) +
  ggplot2::aes(HARV_dsmCrop) +
  # Histogram
  ggplot2::geom_density()
```

Plot with breaks. **Caution:** if bins are uneven, it would be helpful to use the
`width` option on `geom_bar()` to show this.

```{r}
custom_bins <- c(300,350,400,450)
```

Using package `dplyr`. Rather than using pipes `%>%` I explicitly call the `dplyr`
routing `mutate` with first argument as the data frame.

```{r}
ggplot2::ggplot(
  dplyr::mutate(
    as.data.frame(DSM_HARV, xy = TRUE),
    fct_elevation = cut(HARV_dsmCrop, custom_bins))) +
  ggplot2::aes(fct_elevation) +
  # Bar chart
  ggplot2::geom_bar()
```

```{r}
ggplot2::ggplot(
  # Cut values into bins based on `custom_bins` defined above.
  dplyr::mutate(
    as.data.frame(DSM_HARV, xy = TRUE),
    fct_elevation = cut(HARV_dsmCrop, custom_bins))) +
  ggplot2::aes(x, y, fill = fct_elevation) +
  # Raster plot
  ggplot2::geom_raster() +
  # Visualize simple feature objects.
  ggplot2::coord_sf() +
  # Add terrain color pallette.
  ggplot2::scale_fill_manual(values = grDevices::terrain.colors(3))
```

Challenge: use 6 bins. Add title and axis labels.

```{r}
custom_bins <- seq(300, 450, length.out = 7)
```

```{r}
ggplot2::ggplot(
  # Cut values into bins based on `custom_bins` defined above.
  dplyr::mutate(
    as.data.frame(DSM_HARV, xy = TRUE),
    fct_elevation = cut(HARV_dsmCrop, custom_bins))) +
  ggplot2::aes(x, y, fill = fct_elevation) +
  # Raster plot
  ggplot2::geom_raster() +
  # Visualize simple feature objects.
  ggplot2::coord_sf() +
  # Add terrain color pallette.
  ggplot2::scale_fill_manual(values = grDevices::terrain.colors(length(custom_bins) - 1),
                             name = "Elevation") +
  # Add title and axes
  ggplot2::ggtitle("NEON Harvard Forest Crop") +
  ggplot2::labs(x = "UTM Easting Coordinates (m)",
                y = "UTM Northing Coordinates (m)")

```

# Day 2: More Raster Data

Load more data

```{r}
DSM_hill_HARV <- terra::rast("data/raster/HARV_DSMhill.tif")
```

Using parameter `alpha` for [transparency level](https://ggplot2.tidyverse.org/reference/scale_alpha.html).

```{r}
ggplot2::ggplot(
  as.data.frame(DSM_hill_HARV,  xy = TRUE)) +
  # Set aesthetics.
  ggplot2::aes(x, y, alpha = HARV_DSMhill) +
  # Raster plot.
  ggplot2::geom_raster() +
  # Set transparency `alpha` range.
  ggplot2::scale_alpha(range = c(0.15, 0.65),
                       guide = "none")
```

Add crop layer. Here we embed data and aesthetics in each layer as needed.

```{r}
ggplot2::ggplot() +
  
  # Raster hill layer.
  ggplot2::geom_raster(
    data = as.data.frame(DSM_HARV,
                  xy = TRUE),
    ggplot2::aes(x, y, fill = HARV_dsmCrop)) +
  # Color code for crop.
  ggplot2::scale_fill_viridis_c(guide = "none") +
  
  # Raster hill layer.
  ggplot2::geom_raster(
    data = as.data.frame(DSM_hill_HARV,
                  xy = TRUE),
    ggplot2::aes(x, y, alpha = HARV_DSMhill)) +
  # Set transparency `alpha` range.
  ggplot2::scale_alpha(range = c(0.15, 0.65),
                       guide = "none")
```


